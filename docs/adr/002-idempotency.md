# ADR 002: Реализация идемпотентности

## Статус

Принято

## Контекст

API платежей должен быть идемпотентным для предотвращения дублирования списаний. Сетевые сбои, таймауты или повторные попытки клиента могут привести к многократной отправке одного и того же запроса.

## Решение

Мы реализуем идемпотентность используя **подход с двойным хранилищем**:

1. **Redis** для быстрых проверок (основное)
2. **PostgreSQL** для персистентности (резервное)

### Поток

```
1. Клиент отправляет запрос с заголовком Idempotency-Key
2. Проверить Redis на наличие существующего ключа
3. Если найден и завершён → вернуть кэшированный ответ
4. Если найден и обрабатывается → вернуть 409 Conflict
5. Если не найден → проверить PostgreSQL (Redis мог вытеснить)
6. Получить advisory lock → начать обработку
7. Сохранить результат → вернуть ответ
```

### Ключевые компоненты

```typescript
// Проверка идемпотентности
const result = await idempotencyService.check(key, merchantId, requestHash);

// Начать обработку с блокировкой
await idempotencyService.startProcessing(key, merchantId, requestHash, path, method);

// Завершить и закэшировать ответ
await idempotencyService.complete(key, merchantId, response, statusCode);
```

### Хэш запроса

Мы хэшируем тело запроса + путь + метод для определения, используется ли тот же ключ идемпотентности с другими параметрами (что является ошибкой).

### TTL

- Redis: 24 часа (настраивается)
- PostgreSQL: 24 часа, очищается по расписанию

## Рассмотренные альтернативы

### 1. Только Redis
- **Отклонено**: Потеря данных при сбое/вытеснении Redis

### 2. Только PostgreSQL
- **Отклонено**: Слишком медленно для высоконагруженных проверок

### 3. Уникальный constraint в базе
- **Отклонено**: Не обрабатывает состояние "processing"

## Последствия

### Положительные
- Быстрые проверки через Redis
- Персистентный бэкап в PostgreSQL
- Обработка конкурентных запросов через advisory locks
- Обнаружение неправильного использования (тот же ключ, другой запрос)

### Отрицательные
- Две системы хранения для поддержки
- Потенциальное окно несогласованности между Redis и PostgreSQL
- Advisory locks могут вызывать contention при экстремальной нагрузке

## Ссылки

- [Stripe Idempotency](https://stripe.com/docs/api/idempotent_requests)
- [Implementing Idempotency Keys](https://brandur.org/idempotency-keys)
