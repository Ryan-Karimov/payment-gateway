# ADR 001: Saga паттерн для обработки платежей

## Статус

Принято

## Контекст

Обработка платежей включает несколько шагов, которые должны быть скоординированы:
1. Создать запись платежа в базе данных
2. Вызвать внешнего платёжного провайдера (Stripe/PayPal)
3. Обновить статус платежа на основе ответа провайдера
4. Отправить webhook уведомление мерчанту

Если любой шаг не удаётся, нужно корректно обработать частичные сбои.

## Решение

Мы используем **Saga Orchestration паттерн** для координации платёжного потока.

### Почему Saga паттерн?

- **Распределённые транзакции**: Мы не можем использовать традиционные ACID транзакции между PostgreSQL и внешними API
- **Компенсирующие действия**: Каждый шаг может определить действие отката
- **Видимость**: Чёткая последовательность операций для отладки
- **Гибкость**: Легко добавлять/удалять шаги

### Реализация

```typescript
const saga = createSaga<PaymentContext>()
  .addStep({
    name: 'create_payment_record',
    execute: async (ctx) => { /* создать в БД */ },
    compensate: async (ctx) => { /* пометить как failed */ },
  })
  .addStep({
    name: 'process_with_provider',
    execute: async (ctx) => { /* вызвать Stripe/PayPal */ },
  })
  .addStep({
    name: 'send_webhook',
    execute: async (ctx) => { /* поставить webhook в очередь */ },
  });
```

### Порядок компенсации

Компенсации выполняются в **обратном порядке** для поддержания согласованности:
1. Шаг 3 не удался → компенсировать шаг 2, затем шаг 1
2. Каждая компенсация изолирована и обрабатывает свои ошибки

## Рассмотренные альтернативы

### 1. Two-Phase Commit (2PC)
- **Отклонено**: Не поддерживается внешними платёжными API

### 2. Choreography-based Saga
- **Отклонено**: Сложнее понять поток, сложность отладки

### 3. Простой try-catch
- **Отклонено**: Нет структурированного механизма отката

## Последствия

### Положительные
- Чёткая обработка сбоев
- Аудит-лог каждого шага
- Тестируемость в изоляции

### Отрицательные
- Сложнее простого последовательного кода
- Логика компенсации должна быть тщательно спроектирована
- Eventual consistency (не мгновенная согласованность)

## Ссылки

- [Saga Pattern - Microsoft](https://docs.microsoft.com/en-us/azure/architecture/reference-architectures/saga/saga)
- [Implementing Saga Pattern](https://microservices.io/patterns/data/saga.html)
